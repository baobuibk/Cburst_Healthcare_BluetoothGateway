{% extends "base.html" %}
{% block title %}Beacons{% endblock %}
{% block content %}
    <h1>Beacons</h1>
    <input type="text" id="idFilter" placeholder="Filter by ID" onkeyup="fetchBeacons()">
    <select id="gatewayFilter" onchange="fetchBeacons()">
        <option value="">All Gateways</option>
        <option value="GW1">GW1</option>
        <option value="GW2">GW2</option>
        <option value="GW3">GW3</option>
    </select>
    <table id="beaconTable">
        <thead>
            <tr><th>ID</th><th>Gateway</th><th>RSSI</th><th>Last Seen</th><th>Detected</th></tr>
        </thead>
        <tbody></tbody>
    </table>
    <canvas id="rssiChart"></canvas>
    <script>
        const ctx = document.getElementById('rssiChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'RSSI', data: [], borderColor: '#3498db', fill: false }] },
            options: { scales: { y: { beginAtZero: false } } }
        });

        function fetchBeacons() {
            const idFilter = document.getElementById('idFilter').value;
            const gatewayFilter = document.getElementById('gatewayFilter').value;
            fetch(`/api/beacons?id=${idFilter}&gateway=${gatewayFilter}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#beaconTable tbody');
                    tbody.innerHTML = '';
                    chart.data.labels = [];
                    chart.data.datasets[0].data = [];
                    for (const [id, beacon] of Object.entries(data)) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${id}</td>
                            <td>${beacon.gateway}</td>
                            <td>${beacon.rssi}</td>
                            <td>${beacon.last_seen}</td>
                            <td>${beacon.detected ? 'Yes' : 'No'}</td>
                        `;
                        tbody.appendChild(tr);
                        chart.data.labels.push(id);
                        chart.data.datasets[0].data.push(beacon.rssi);
                    }
                    chart.update();
                });
        }

        fetchBeacons();
    </script>
{% endblock %}